<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Zadrga</title>
	<style>
		body{
			margin: 0;
			background: #f7b731;
			min-height: 100vh;
		}

		canvas{
			position: fixed;
			top: 0;
			left: 0;
		}
	</style>
</head>
<body>
	Lorem ipsum

	<canvas id="zadrga"></canvas>
	<script type="text/javascript">
		CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
		  if (w < 2 * r) r = w / 2;
		  if (h < 2 * r) r = h / 2;
		  //this.beginPath();
		  this.moveTo(x+r, y);
		  this.arcTo(x+w, y,   x+w, y+h, r);
		  this.arcTo(x+w, y+h, x,   y+h, r);
		  this.arcTo(x,   y+h, x,   y,   r);
		  this.arcTo(x,   y,   x+w, y,   r);

		  this.closePath();
		  return this;
		}

		let c = document.getElementById("zadrga");
		let ctx = c.getContext("2d");

		let size = 50;
		let position = 0;
		let targetPosition = 0;
		let w, h;

		let running = true;
		let t2 = 0;

		function render(){
			//position = 1400;
			ctx.clearRect(0,0,w,h);

			// pobarvaj ozadje
			ctx.fillStyle = "#2bcbba"
			ctx.shadowBlur = 0;
			ctx.shadowColor = 'rgba(0,0,0,0)';
			ctx.beginPath();
			let margin = Math.sqrt(4*(size*size)/8);
			ctx.arc(0, position, w/2-margin, Math.PI, 2*Math.PI);
			ctx.fill();
			ctx.beginPath();
			ctx.arc(w, position, w/2-margin, Math.PI, 2*Math.PI);
			ctx.fill();
			ctx.fillRect(0,position, w, h-position);

			let n;
			// narisi toothcke zadrge na ravnem delu
			n = Math.ceil((h-position)/size);
			for(let i=0; i<n; i++){
				// leva stran
				tooth(w/2, h - size*i, Math.PI/2);
				//desna stran
				tooth(w/2, h - size*(i+.5), -Math.PI/2);
			}

			// narisi zobcke zadrge na kroznem delu
			let clx = 0;
			let cly = position;
			let crx = w;
			let cry = position;
			let r = w/2;
			let offeset = n*size - (h-position);
			let angleOffset = offeset/r;
			n = (Math.PI*r)/size;
			for(let i=0; i<n; i++){
				//leva stran
				let angle = Math.PI/2+(Math.PI/n)*i + angleOffset;
				let sin = Math.sin(angle);
				let cos = Math.cos(angle);
				tooth(sin*(r)+clx, cos*(r)+cly, angle);
				//desna stran
				angle = Math.PI/2+(Math.PI/n)*(i+.5) + angleOffset;
				sin = Math.sin(-angle);
				cos = Math.cos(-angle);
				tooth(sin*(r)+crx, cos*(r)+cry, -angle);
			}


			//narisi colnicek
			ctx.fillStyle = "#eee";
			ctx.shadowBlur = 15;
			ctx.shadowColor = 'rgba(30,30,30,0.2)';
			ctx.shadowColor = 'rgba(30,30,30,0.2)';
			ctx.beginPath();
			ctx.moveTo(w/2, position-size*4);
			ctx.lineTo(w/2+size*2, position-size*3.3);
			ctx.lineTo(w/2+size*1.5, position);
			ctx.lineTo(w/2-size*1.5, position);
			ctx.lineTo(w/2-size*2, position-size*3.3);
			ctx.closePath();
			ctx.fill();

			//rocaj colnicka
			ctx.beginPath();
			ctx.roundRect(w/2-size*.6, position-size*1.4, size*1.2, size*1.5,size/4);
			ctx.roundRect(w/2-size*1.2, position-size*2, size*2.4, size*5,size/2);
			ctx.closePath();
			ctx.fill("evenodd");

			//
			ctx.beginPath();
			ctx.roundRect(w/2-size*.3, position-size*3.5, size*.6, size*3, size/2);
			ctx.closePath();
			ctx.fill();
		}

		function tooth(x, y, angle){
			let r = Math.sqrt((size*size)/8);
			ctx.save();
			ctx.translate(x,y);
			ctx.rotate(-angle+Math.PI);
			ctx.fillStyle = "#eee";
			ctx.shadowBlur = 15;
			ctx.shadowColor = 'rgba(30,30,30,0.2)';

			ctx.beginPath();
			let sqrt = Math.sqrt(2*r*r);
			ctx.moveTo(-sqrt, sqrt+2*r - sqrt/2);
			ctx.arc(-sqrt, sqrt - sqrt/2, r, Math.PI/2, -Math.PI/4, true);
			ctx.arc(0, 0 - sqrt/2, r, Math.PI-Math.PI/4, Math.PI*2+Math.PI/4); // binkica na koncu
			ctx.arc(sqrt, sqrt - sqrt/2, r, Math.PI+Math.PI/4, Math.PI/2, true);
			ctx.lineTo(sqrt, sqrt+2*r - sqrt/2);
			ctx.closePath();

			ctx.fill();
			ctx.restore();
		}


		function resize(){
			w = c.width = window.innerWidth;
			h = c.height = window.innerHeight;
			size = Math.min(w,h)/20;
			render();
		}

		function mousemove(e){
			//position = e.clientY;
			//render();
		}

		function mousewheel(e){
			var e = window.event || e; // old IE support
    	var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
			targetPosition += -delta*100;
			if(!running)animation();

			console.log(delta);
		}

		function animation(t){
			//console.log(t-t2);
			if(t-t2 > 16){
				t2 = t;
				position += Math.floor((targetPosition-position)/10);
					if(position < (h+w/2)){
						c.style.display = "block";
						render();
					}
				else{
					c.style.display = "none";
					running = false;
				}

			}
			if(running){
				requestAnimationFrame(animation);
			}

			//console.log("running");
		}

		resize();
		animation();

		if (c.addEventListener){
		    // IE9, Chrome, Safari, Opera
		    c.addEventListener("mousewheel", mousewheel, false);
		    // Firefox
		    c.addEventListener("DOMMouseScroll", mousewheel, false);
		}// IE 6/7/8
		else{
		    c.attachEvent("onmousewheel", mousewheel);
		}
		window.onmousemove = mousemove;
		window.onresize = resize;
	</script>
</body>
</html>
